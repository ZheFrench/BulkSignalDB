"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.attachControllerInstances = exports.attachControllers = void 0;
const express_1 = require("express");
const di_1 = require("@decorators/di");
const meta_1 = require("./meta");
const middleware_1 = require("./middleware");
/**
 * Attach controllers to express application
 *
 * @param {Express} app Express application
 * @param {Type[]} controllers Controllers array
 */
function attachControllers(app, controllers) {
    controllers.forEach((controller) => registerController(app, controller, getController));
    // error middleware must be registered as the very last one
    app.use(middleware_1.errorMiddlewareHandler());
}
exports.attachControllers = attachControllers;
/**
 * Attach controller instances to express application
 *
 * @param {Express} app Express application
 * @param {any[]} controllers Controllers array
 */
function attachControllerInstances(app, controllers) {
    controllers.forEach((controller) => registerController(app, controller, (c) => c));
    // error middleware must be registered as the very last one
    app.use(middleware_1.errorMiddlewareHandler());
}
exports.attachControllerInstances = attachControllerInstances;
/**
 * Register controller via registering new Router
 *
 * @param {Application} app
 * @param {ExpressClass} Controller
 * @returns
 */
function registerController(app, Controller, _getController) {
    const controller = _getController(Controller);
    const meta = meta_1.getMeta(controller);
    const router = express_1.Router(meta.routerOptions);
    const routes = meta.routes;
    const url = meta.url;
    const params = meta.params;
    /**
     * Wrap all registered middleware with helper function
     * that can instantiate or get from the container instance of the class
     * or execute given middleware function
     * @see getMiddleware
     */
    const routerMiddleware = (meta.middleware || [])
        .map(middleware => middleware_1.middlewareHandler(middleware));
    /**
     * Apply router middleware
     */
    if (routerMiddleware.length) {
        router.use(...routerMiddleware);
    }
    /**
     * Applying registered routes
     */
    for (const methodName of Object.keys(routes)) {
        const route = routes[methodName];
        const routeHandler = (req, res, next) => {
            const args = extractParameters(req, res, next, params[methodName]);
            const handler = controller[methodName].apply(controller, args);
            if (handler instanceof Promise) {
                handler.catch(next);
            }
            return handler;
        };
        const routeMiddleware = (route.middleware || [])
            .map(middleware => middleware_1.middlewareHandler(middleware));
        router[route.method].apply(router, [
            route.url, ...routeMiddleware, routeHandler
        ]);
    }
    app.use(url, router);
    return app;
}
/**
 * Extract parameters for handlers
 *
 * @param {Request} req
 * @param {Response} res
 * @param {NextFunction} next
 * @param {ParameterConfiguration[]} params
 *
 * @returns {any[]}
 */
function extractParameters(req, res, next, params) {
    if (!params || !params.length) {
        return [req, res, next];
    }
    const args = [];
    for (const { name, index, type } of params) {
        switch (type) {
            case meta_1.ParameterType.RESPONSE:
                args[index] = res;
                break;
            case meta_1.ParameterType.REQUEST:
                args[index] = getParam(req, null, name);
                break;
            case meta_1.ParameterType.NEXT:
                args[index] = next;
                break;
            case meta_1.ParameterType.PARAMS:
                args[index] = getParam(req, 'params', name);
                break;
            case meta_1.ParameterType.QUERY:
                args[index] = getParam(req, 'query', name);
                break;
            case meta_1.ParameterType.BODY:
                args[index] = getParam(req, 'body', name);
                break;
            case meta_1.ParameterType.HEADERS:
                args[index] = getParam(req, 'headers', name);
                break;
            case meta_1.ParameterType.COOKIES:
                args[index] = getParam(req, 'cookies', name);
                break;
        }
    }
    return args;
}
/**
 * Get controller instance from container or instantiate one
 *
 * @param {any} Controller
 *
 * @returns {ExpressClass}
 */
function getController(Controller) {
    try {
        return di_1.Container.get(Controller);
    }
    catch (_a) {
        return new Controller();
    }
}
/**
 * Get parameter value from the source object
 *
 * @param {*} source
 * @param {string} paramType
 * @param {string} name
 *
 * @returns {*}
 */
function getParam(source, paramType, name) {
    const param = source[paramType] || source;
    return name ? param[name] : param;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leHByZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHFDQUF3RztBQUN4Ryx1Q0FBMkM7QUFFM0MsaUNBQTBHO0FBQzFHLDZDQUErRTtBQUUvRTs7Ozs7R0FLRztBQUNILFNBQWdCLGlCQUFpQixDQUFDLEdBQXFCLEVBQUUsV0FBbUI7SUFDMUUsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQWdCLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxVQUFVLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQztJQUU5RiwyREFBMkQ7SUFDM0QsR0FBRyxDQUFDLEdBQUcsQ0FBQyxtQ0FBc0IsRUFBRSxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUxELDhDQUtDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFnQix5QkFBeUIsQ0FBQyxHQUFxQixFQUFFLFdBQXFCO0lBQ3BGLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFnQixFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRWpHLDJEQUEyRDtJQUMzRCxHQUFHLENBQUMsR0FBRyxDQUFDLG1DQUFzQixFQUFFLENBQUMsQ0FBQztBQUNwQyxDQUFDO0FBTEQsOERBS0M7QUFFRDs7Ozs7O0dBTUc7QUFDSCxTQUFTLGtCQUFrQixDQUFDLEdBQXlCLEVBQUUsVUFBdUIsRUFBRSxjQUFnRDtJQUM5SCxNQUFNLFVBQVUsR0FBaUIsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzVELE1BQU0sSUFBSSxHQUFnQixjQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDOUMsTUFBTSxNQUFNLEdBQVcsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbEQsTUFBTSxNQUFN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QUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdEhhbmRsZXIsIEFwcGxpY2F0aW9uLCBSb3V0ZXIsIEV4cHJlc3MsIFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IENvbnRhaW5lciB9IGZyb20gJ0BkZWNvcmF0b3JzL2RpJztcblxuaW1wb3J0IHsgRXhwcmVzc01ldGEsIGdldE1ldGEsIFBhcmFtZXRlclR5cGUsIEV4cHJlc3NDbGFzcywgUm91dGUsIFBhcmFtZXRlckNvbmZpZ3VyYXRpb24gfSBmcm9tICcuL21ldGEnO1xuaW1wb3J0IHsgbWlkZGxld2FyZUhhbmRsZXIsIGVycm9yTWlkZGxld2FyZUhhbmRsZXIsIFR5cGUgfSBmcm9tICcuL21pZGRsZXdhcmUnO1xuXG4vKipcbiAqIEF0dGFjaCBjb250cm9sbGVycyB0byBleHByZXNzIGFwcGxpY2F0aW9uXG4gKlxuICogQHBhcmFtIHtFeHByZXNzfSBhcHAgRXhwcmVzcyBhcHBsaWNhdGlvblxuICogQHBhcmFtIHtUeXBlW119IGNvbnRyb2xsZXJzIENvbnRyb2xsZXJzIGFycmF5XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hDb250cm9sbGVycyhhcHA6IEV4cHJlc3MgfCBSb3V0ZXIsIGNvbnRyb2xsZXJzOiBUeXBlW10pIHtcbiAgY29udHJvbGxlcnMuZm9yRWFjaCgoY29udHJvbGxlcjogVHlwZSkgPT4gcmVnaXN0ZXJDb250cm9sbGVyKGFwcCwgY29udHJvbGxlciwgZ2V0Q29udHJvbGxlcikpO1xuXG4gIC8vIGVycm9yIG1pZGRsZXdhcmUgbXVzdCBiZSByZWdpc3RlcmVkIGFzIHRoZSB2ZXJ5IGxhc3Qgb25lXG4gIGFwcC51c2UoZXJyb3JNaWRkbGV3YXJlSGFuZGxlcigpKTtcbn1cblxuLyoqXG4gKiBBdHRhY2ggY29udHJvbGxlciBpbnN0YW5jZXMgdG8gZXhwcmVzcyBhcHBsaWNhdGlvblxuICpcbiAqIEBwYXJhbSB7RXhwcmVzc30gYXBwIEV4cHJlc3MgYXBwbGljYXRpb25cbiAqIEBwYXJhbSB7YW55W119IGNvbnRyb2xsZXJzIENvbnRyb2xsZXJzIGFycmF5XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hDb250cm9sbGVySW5zdGFuY2VzKGFwcDogRXhwcmVzcyB8IFJvdXRlciwgY29udHJvbGxlcnM6IG9iamVjdFtdKSB7XG4gIGNvbnRyb2xsZXJzLmZvckVhY2goKGNvbnRyb2xsZXI6IFR5cGUpID0+IHJlZ2lzdGVyQ29udHJvbGxlcihhcHAsIGNvbnRyb2xsZXIsIChjOiBvYmplY3QpID0+IGMpKTtcblxuICAvLyBlcnJvciBtaWRkbGV3YXJlIG11c3QgYmUgcmVnaXN0ZXJlZCBhcyB0aGUgdmVyeSBsYXN0IG9uZVxuICBhcHAudXNlKGVycm9yTWlkZGxld2FyZUhhbmRsZXIoKSk7XG59XG5cbi8qKlxuICogUmVnaXN0ZXIgY29udHJvbGxlciB2aWEgcmVnaXN0ZXJpbmcgbmV3IFJvdXRlclxuICpcbiAqIEBwYXJhbSB7QXBwbGljYXRpb259IGFwcFxuICogQHBhcmFtIHtFeHByZXNzQ2xhc3N9IENvbnRyb2xsZXJcbiAqIEByZXR1cm5zXG4gKi9cbmZ1bmN0aW9uIHJlZ2lzdGVyQ29udHJvbGxlcihhcHA6IEFwcGxpY2F0aW9uIHwgUm91dGVyLCBDb250cm9sbGVyOiBUeXBlfG9iamVjdCwgX2dldENvbnRyb2xsZXI6IChjOiBUeXBlfG9iamVjdCkgPT4gRXhwcmVzc0NsYXNzKSB7XG4gIGNvbnN0IGNvbnRyb2xsZXI6IEV4cHJlc3NDbGFzcyA9IF9nZXRDb250cm9sbGVyKENvbnRyb2xsZXIpO1xuICBjb25zdCBtZXRhOiBFeHByZXNzTWV0YSA9IGdldE1ldGEoY29udHJvbGxlcik7XG4gIGNvbnN0IHJvdXRlcjogUm91dGVyID0gUm91dGVyKG1ldGEucm91dGVyT3B0aW9ucyk7XG4gIGNvbnN0IHJvdXRlczogb2JqZWN0ID0gbWV0YS5yb3V0ZXM7XG4gIGNvbnN0IHVybDogc3RyaW5nID0gbWV0YS51cmw7XG4gIGNvbnN0IHBhcmFtczogb2JqZWN0ID0gbWV0YS5wYXJhbXM7XG5cbiAgLyoqXG4gICAqIFdyYXAgYWxsIHJlZ2lzdGVyZWQgbWlkZGxld2FyZSB3aXRoIGhlbHBlciBmdW5jdGlvblxuICAgKiB0aGF0IGNhbiBpbnN0YW50aWF0ZSBvciBnZXQgZnJvbSB0aGUgY29udGFpbmVyIGluc3RhbmNlIG9mIHRoZSBjbGFzc1xuICAgKiBvciBleGVjdXRlIGdpdmVuIG1pZGRsZXdhcmUgZnVuY3Rpb25cbiAgICogQHNlZSBnZXRNaWRkbGV3YXJlXG4gICAqL1xuICBjb25zdCByb3V0ZXJNaWRkbGV3YXJlOiBSZXF1ZXN0SGFuZGxlcltdID0gKG1ldGEubWlkZGxld2FyZSB8fCBbXSlcbiAgICAubWFwKG1pZGRsZXdhcmUgPT4gbWlkZGxld2FyZUhhbmRsZXIobWlkZGxld2FyZSkpO1xuXG4gIC8qKlxuICAgKiBBcHBseSByb3V0ZXIgbWlkZGxld2FyZVxuICAgKi9cbiAgaWYgKHJvdXRlck1pZGRsZXdhcmUubGVuZ3RoKSB7XG4gICAgcm91dGVyLnVzZSguLi5yb3V0ZXJNaWRkbGV3YXJlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseWluZyByZWdpc3RlcmVkIHJvdXRlc1xuICAgKi9cbiAgZm9yIChjb25zdCBtZXRob2ROYW1lIG9mIE9iamVjdC5rZXlzKHJvdXRlcykpIHtcbiAgICBjb25zdCByb3V0ZTogUm91dGUgPSByb3V0ZXNbbWV0aG9kTmFtZV07XG5cbiAgICBjb25zdCByb3V0ZUhhbmRsZXIgPSAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IGFyZ3MgPSBleHRyYWN0UGFyYW1ldGVycyhyZXEsIHJlcywgbmV4dCwgcGFyYW1zW21ldGhvZE5hbWVdKTtcbiAgICAgIGNvbnN0IGhhbmRsZXIgPSBjb250cm9sbGVyW21ldGhvZE5hbWVdLmFwcGx5KGNvbnRyb2xsZXIsIGFyZ3MpO1xuXG4gICAgICBpZiAoaGFuZGxlciBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgICAgICBoYW5kbGVyLmNhdGNoKG5leHQpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gaGFuZGxlcjtcbiAgICB9O1xuXG4gICAgY29uc3Qgcm91dGVNaWRkbGV3YXJlOiBSZXF1ZXN0SGFuZGxlcltdID0gKHJvdXRlLm1pZGRsZXdhcmUgfHwgW10pXG4gICAgICAubWFwKG1pZGRsZXdhcmUgPT4gbWlkZGxld2FyZUhhbmRsZXIobWlkZGxld2FyZSkpO1xuXG4gICAgcm91dGVyW3JvdXRlLm1ldGhvZF0uYXBwbHkocm91dGVyLCBbXG4gICAgICByb3V0ZS51cmwsIC4uLnJvdXRlTWlkZGxld2FyZSwgcm91dGVIYW5kbGVyXG4gICAgXSk7XG4gIH1cblxuICAoYXBwIGFzIFJvdXRlcikudXNlKHVybCwgcm91dGVyKTtcblxuICByZXR1cm4gYXBwO1xufVxuXG4vKipcbiAqIEV4dHJhY3QgcGFyYW1ldGVycyBmb3IgaGFuZGxlcnNcbiAqXG4gKiBAcGFyYW0ge1JlcXVlc3R9IHJlcVxuICogQHBhcmFtIHtSZXNwb25zZX0gcmVzXG4gKiBAcGFyYW0ge05leHRGdW5jdGlvbn0gbmV4dFxuICogQHBhcmFtIHtQYXJhbWV0ZXJDb25maWd1cmF0aW9uW119IHBhcmFtc1xuICpcbiAqIEByZXR1cm5zIHthbnlbXX1cbiAqL1xuZnVuY3Rpb24gZXh0cmFjdFBhcmFtZXRlcnMocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24sIHBhcmFtczogUGFyYW1ldGVyQ29uZmlndXJhdGlvbltdKTogYW55W10ge1xuICBpZiAoIXBhcmFtcyB8fCAhcGFyYW1zLmxlbmd0aCkge1xuICAgIHJldHVybiBbIHJlcSwgcmVzLCBuZXh0IF07XG4gIH1cblxuICBjb25zdCBhcmdzID0gW107XG5cbiAgZm9yIChjb25zdCB7IG5hbWUsIGluZGV4LCB0eXBlIH0gb2YgcGFyYW1zKSB7XG5cbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5SRVNQT05TRTpcbiAgICAgICAgYXJnc1tpbmRleF0gPSByZXM7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLlJFUVVFU1Q6XG4gICAgICAgIGFyZ3NbaW5kZXhdID0gZ2V0UGFyYW0ocmVxLCBudWxsLCBuYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFBhcmFtZXRlclR5cGUuTkVYVDpcbiAgICAgICAgYXJnc1tpbmRleF0gPSBuZXh0O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5QQVJBTVM6XG4gICAgICAgIGFyZ3NbaW5kZXhdID0gZ2V0UGFyYW0ocmVxLCAncGFyYW1zJywgbmFtZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLlFVRVJZOlxuICAgICAgICBhcmdzW2luZGV4XSA9IGdldFBhcmFtKHJlcSwgJ3F1ZXJ5JywgbmFtZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLkJPRFk6XG4gICAgICAgIGFyZ3NbaW5kZXhdID0gZ2V0UGFyYW0ocmVxLCAnYm9keScsIG5hbWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5IRUFERVJTOlxuICAgICAgICBhcmdzW2luZGV4XSA9IGdldFBhcmFtKHJlcSwgJ2hlYWRlcnMnLCBuYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFBhcmFtZXRlclR5cGUuQ09PS0lFUzpcbiAgICAgICAgYXJnc1tpbmRleF0gPSBnZXRQYXJhbShyZXEsICdjb29raWVzJywgbmFtZSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICB9XG5cbiAgcmV0dXJuIGFyZ3M7XG59XG5cbi8qKlxuICogR2V0IGNvbnRyb2xsZXIgaW5zdGFuY2UgZnJvbSBjb250YWluZXIgb3IgaW5zdGFudGlhdGUgb25lXG4gKlxuICogQHBhcmFtIHthbnl9IENvbnRyb2xsZXJcbiAqXG4gKiBAcmV0dXJucyB7RXhwcmVzc0NsYXNzfVxuICovXG5mdW5jdGlvbiBnZXRDb250cm9sbGVyKENvbnRyb2xsZXI6IFR5cGUpOiBFeHByZXNzQ2xhc3Mge1xuICB0cnkge1xuICAgIHJldHVybiBDb250YWluZXIuZ2V0KENvbnRyb2xsZXIpO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gbmV3IENvbnRyb2xsZXIoKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCBwYXJhbWV0ZXIgdmFsdWUgZnJvbSB0aGUgc291cmNlIG9iamVjdFxuICpcbiAqIEBwYXJhbSB7Kn0gc291cmNlXG4gKiBAcGFyYW0ge3N0cmluZ30gcGFyYW1UeXBlXG4gKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICpcbiAqIEByZXR1cm5zIHsqfVxuICovXG5mdW5jdGlvbiBnZXRQYXJhbShzb3VyY2U6IGFueSwgcGFyYW1UeXBlOiBzdHJpbmcsIG5hbWU6IHN0cmluZyk6IGFueSB7XG4gIGNvbnN0IHBhcmFtID0gc291cmNlW3BhcmFtVHlwZV0gfHwgc291cmNlO1xuXG4gIHJldHVybiBuYW1lID8gcGFyYW1bbmFtZV0gOiBwYXJhbTtcbn1cbiJdfQ==