"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const di_1 = require("@decorators/di");
const meta_1 = require("./meta");
const middleware_1 = require("./middleware");
/**
 * Attaches controllers to IO server
 *
 * @param {SocketIO.Server} io
 * @param {Type[]} controllers
 */
function attachControllers(io, controllers) {
    io.use((socket, next) => middleware_1.middlewareHandler(middleware_1.IO_MIDDLEWARE)(io, socket, next));
    controllers.forEach((controller) => attachController(io, controller));
}
exports.attachControllers = attachControllers;
/**
 * Attach Controller
 *
 * @param {SocketIO.Server} IO
 * @param {Type} Controller
 */
function attachController(io, controller) {
    const instance = di_1.Container.get(controller);
    const meta = meta_1.getMeta(instance);
    const ioNS = io.of(meta.namespace);
    /**
     * Apply io based events
     */
    applyEvents(io, null, controller, meta_1.EventType.IO);
    /**
     * Apply local listeners (socket based)
     */
    ioNS.on('connection', (socket) => {
        /**
         * Apply all registered controller-based and event-based middlewares to socket
         */
        socket.use(socketMiddlewareHandler(io, socket, meta));
        /**
         * Apply socket based events
         */
        applyEvents(io, socket, controller, meta_1.EventType.Socket);
    });
}
/**
 * Handler for all registered controller based middleware
 *
 * @param {IO} io
 * @param {SocketIO.Socket} socket
 * @param {SocketMeta} meta
 */
function socketMiddlewareHandler(io, socket, meta) {
    return (packet, next) => {
        const [event, data] = packet;
        const args = [io, socket, { event, data }];
        /**
         * Find listener that serves this event
         */
        const listener = meta.listeners
            .find((lst) => lst.event === event);
        /**
         * And if listener exists, loop through controller middlewares
         * and after that event (registered in listener) middlewares
         */
        if (listener) {
            return middleware_1.executeMiddleware(meta.middleware, args)
                .then(() => middleware_1.executeMiddleware(listener.middleware, args))
                .then(() => next())
                .catch(err => next(err));
        }
        next();
    };
}
/**
 * Apply listeners to socket or io
 *
 * @param {SocketIO.Server|SocketIO.Namespace} io
 * @param {SocketIO.Socket} socket
 * @param {Type} controller
 * @param {EventType} type
 */
function applyEvents(io, socket, controller, type) {
    const instance = di_1.Container.get(controller);
    const meta = meta_1.getMeta(instance);
    const ioSock = socket || io;
    meta.listeners
        .filter((listener) => listener.type === type)
        .forEach((listener) => ioSock.on(listener.event, (...args) => {
        const methodName = listener.methodName;
        const newArgs = mapArguments(io, socket || args[0], meta.params[methodName], args);
        return instance[methodName].apply(instance, newArgs);
    }));
}
/**
 * Map parameters for new handler
 *
 * @param {SocketIO.Server|SocketIO.Namespace} io
 * @param {SocketIO.Socket} socket
 * @param {Param[]} params Meta parameters
 * @param {any[]} args Event handler arguments
 * @returns {Array} returns arguments array, or io and socket, event args by default
 */
function mapArguments(io, socket, params, args) {
    /**
     * if no parameters provided, return io and socket, and event arguments
     * (which came for default handler)
     */
    if (!params || !params.length) {
        return [io, socket, ...args];
    }
    /**
     * loop through all params and put them into correct order
     */
    return params
        .sort((p1, p2) => p1.index - p2.index)
        .map((param) => {
        switch (param.type) {
            case meta_1.ParameterType.IO: return getWrapper(param, io);
            case meta_1.ParameterType.Socket: return getWrapper(param, socket);
            case meta_1.ParameterType.Args: return getArgs(args);
            case meta_1.ParameterType.Ack: return getAck(args);
        }
    });
}
/**
 * Get ack callback function
 * @description extract callback function, it it exists
 *
 * @param {any[]} args Event arguments, passed to handler function
 */
function getAck(args) {
    const ackExists = typeof args[args.length - 1] === 'function';
    return ackExists ? args.pop() : noop;
}
/**
 * Get proper message data
 *
 * @param {any[]} args
 *
 * @returns {*}
 */
function getArgs(args) {
    return typeof args[args.length - 1] === 'function' ?
        args[args.length - 2] : args[args.length - 1];
}
/**
 * Get original socket or io server, or create instance of passed WrapperClass (data)
 *
 * @param {Param} item
 * @param {object} obj
 *
 * @returns {*}
 */
function getWrapper(item, obj) {
    return item.wrapper ? new item.wrapper(obj) : obj;
}
/**
 * Dummy empty function, to ensure that callback exists
 */
function noop() { }
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NvY2tldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUEyQztBQUUzQyxpQ0FRZ0I7QUFDaEIsNkNBQXlGO0FBRXpGOzs7OztHQUtHO0FBQ0gsU0FBZ0IsaUJBQWlCLENBQUMsRUFBbUIsRUFBRSxXQUFtQjtJQUN4RSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsOEJBQWlCLENBQUMsMEJBQWEsQ0FBQyxDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUU3RSxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBZ0IsRUFBRSxFQUFFLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7QUFDOUUsQ0FBQztBQUpELDhDQUlDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFTLGdCQUFnQixDQUN2QixFQUFtQixFQUNuQixVQUFnQjtJQUVoQixNQUFNLFFBQVEsR0FBZ0IsY0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN4RCxNQUFNLElBQUksR0FBZSxjQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDM0MsTUFBTSxJQUFJLEdBQXVCLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRXZEOztPQUVHO0lBQ0gsV0FBVyxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLGdCQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFaEQ7O09BRUc7SUFDSCxJQUFJLENBQUMsRUFBRSxDQUFDLFlBQVksRUFBRSxDQUFDLE1BQXVCLEVBQUUsRUFBRTtRQUNoRDs7V0FFRztRQUNGLE1BQWMsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMs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RSxHQUFXO0lBQzFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7QUFDcEQsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUyxJQUFJLEtBQUksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRhaW5lciB9IGZyb20gJ0BkZWNvcmF0b3JzL2RpJztcblxuaW1wb3J0IHtcbiAgUGFyYW1ldGVyVHlwZSxcbiAgUGFyYW0sXG4gIEV2ZW50VHlwZSxcbiAgTGlzdGVuZXIsXG4gIFNvY2tldE1ldGEsXG4gIFNvY2tldENsYXNzLFxuICBnZXRNZXRhXG59IGZyb20gJy4vbWV0YSc7XG5pbXBvcnQgeyBleGVjdXRlTWlkZGxld2FyZSwgSU9fTUlERExFV0FSRSwgbWlkZGxld2FyZUhhbmRsZXIsIFR5cGUgfSBmcm9tICcuL21pZGRsZXdhcmUnO1xuXG4vKipcbiAqIEF0dGFjaGVzIGNvbnRyb2xsZXJzIHRvIElPIHNlcnZlclxuICpcbiAqIEBwYXJhbSB7U29ja2V0SU8uU2VydmVyfSBpb1xuICogQHBhcmFtIHtUeXBlW119IGNvbnRyb2xsZXJzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hDb250cm9sbGVycyhpbzogU29ja2V0SU8uU2VydmVyLCBjb250cm9sbGVyczogVHlwZVtdKSB7XG4gIGlvLnVzZSgoc29ja2V0LCBuZXh0KSA9PiBtaWRkbGV3YXJlSGFuZGxlcihJT19NSURETEVXQVJFKShpbywgc29ja2V0LCBuZXh0KSk7XG5cbiAgY29udHJvbGxlcnMuZm9yRWFjaCgoY29udHJvbGxlcjogVHlwZSkgPT4gYXR0YWNoQ29udHJvbGxlcihpbywgY29udHJvbGxlcikpO1xufVxuXG4vKipcbiAqIEF0dGFjaCBDb250cm9sbGVyXG4gKlxuICogQHBhcmFtIHtTb2NrZXRJTy5TZXJ2ZXJ9IElPXG4gKiBAcGFyYW0ge1R5cGV9IENvbnRyb2xsZXJcbiAqL1xuZnVuY3Rpb24gYXR0YWNoQ29udHJvbGxlcihcbiAgaW86IFNvY2tldElPLlNlcnZlcixcbiAgY29udHJvbGxlcjogVHlwZVxuKSB7XG4gIGNvbnN0IGluc3RhbmNlOiBTb2NrZXRDbGFzcyA9IENvbnRhaW5lci5nZXQoY29udHJvbGxlcik7XG4gIGNvbnN0IG1ldGE6IFNvY2tldE1ldGEgPSBnZXRNZXRhKGluc3RhbmNlKTtcbiAgY29uc3QgaW9OUzogU29ja2V0SU8uTmFtZXNwYWNlID0gaW8ub2YobWV0YS5uYW1lc3BhY2UpO1xuXG4gIC8qKlxuICAgKiBBcHBseSBpbyBiYXNlZCBldmVudHNcbiAgICovXG4gIGFwcGx5RXZlbnRzKGlvLCBudWxsLCBjb250cm9sbGVyLCBFdmVudFR5cGUuSU8pO1xuXG4gIC8qKlxuICAgKiBBcHBseSBsb2NhbCBsaXN0ZW5lcnMgKHNvY2tldCBiYXNlZClcbiAgICovXG4gIGlvTlMub24oJ2Nvbm5lY3Rpb24nLCAoc29ja2V0OiBTb2NrZXRJTy5Tb2NrZXQpID0+IHtcbiAgICAvKipcbiAgICAgKiBBcHBseSBhbGwgcmVnaXN0ZXJlZCBjb250cm9sbGVyLWJhc2VkIGFuZCBldmVudC1iYXNlZCBtaWRkbGV3YXJlcyB0byBzb2NrZXRcbiAgICAgKi9cbiAgICAoc29ja2V0IGFzIGFueSkudXNlKHNvY2tldE1pZGRsZXdhcmVIYW5kbGVyKGlvLCBzb2NrZXQsIG1ldGEpKTtcblxuICAgIC8qKlxuICAgICAqIEFwcGx5IHNvY2tldCBiYXNlZCBldmVudHNcbiAgICAgKi9cbiAgICBhcHBseUV2ZW50cyhpbywgc29ja2V0LCBjb250cm9sbGVyLCBFdmVudFR5cGUuU29ja2V0KTtcbiAgfSk7XG59XG5cbi8qKlxuICogSGFuZGxlciBmb3IgYWxsIHJlZ2lzdGVyZWQgY29udHJvbGxlciBiYXNlZCBtaWRkbGV3YXJlXG4gKlxuICogQHBhcmFtIHtJT30gaW9cbiAqIEBwYXJhbSB7U29ja2V0SU8uU29ja2V0fSBzb2NrZXRcbiAqIEBwYXJhbSB7U29ja2V0TWV0YX0gbWV0YVxuICovXG5mdW5jdGlvbiBzb2NrZXRNaWRkbGV3YXJlSGFuZGxlcihpbzogSU8sIHNvY2tldDogU29ja2V0SU8uU29ja2V0LCBtZXRhOiBTb2NrZXRNZXRhKSB7XG4gIHJldHVybiAocGFja2V0LCBuZXh0KSA9PiB7XG4gICAgY29uc3QgWyBldmVudCwgZGF0YSBdOiBzdHJpbmcgPSBwYWNrZXQ7XG4gICAgY29uc3QgYXJncyA9IFsgaW8sIHNvY2tldCwgeyBldmVudCwgZGF0YSB9IF07XG4gICAgLyoqXG4gICAgICogRmluZCBsaXN0ZW5lciB0aGF0IHNlcnZlcyB0aGlzIGV2ZW50XG4gICAgICovXG4gICAgY29uc3QgbGlzdGVuZXIgPSBtZXRhLmxpc3RlbmVyc1xuICAgICAgLmZpbmQoKGxzdDogTGlzdGVuZXIpID0+IGxzdC5ldmVudCA9PT0gZXZlbnQpO1xuXG4gICAgLyoqXG4gICAgICogQW5kIGlmIGxpc3RlbmVyIGV4aXN0cywgbG9vcCB0aHJvdWdoIGNvbnRyb2xsZXIgbWlkZGxld2FyZXNcbiAgICAgKiBhbmQgYWZ0ZXIgdGhhdCBldmVudCAocmVnaXN0ZXJlZCBpbiBsaXN0ZW5lcikgbWlkZGxld2FyZXNcbiAgICAgKi9cbiAgICBpZiAobGlzdGVuZXIpIHtcbiAgICAgIHJldHVybiBleGVjdXRlTWlkZGxld2FyZShtZXRhLm1pZGRsZXdhcmUsIGFyZ3MpXG4gICAgICAgIC50aGVuKCgpID0+IGV4ZWN1dGVNaWRkbGV3YXJlKGxpc3RlbmVyLm1pZGRsZXdhcmUsIGFyZ3MpKVxuICAgICAgICAudGhlbigoKSA9PiBuZXh0KCkpXG4gICAgICAgIC5jYXRjaChlcnIgPT4gbmV4dChlcnIpKTtcbiAgICB9XG5cbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbi8qKlxuICogQXBwbHkgbGlzdGVuZXJzIHRvIHNvY2tldCBvciBpb1xuICpcbiAqIEBwYXJhbSB7U29ja2V0SU8uU2VydmVyfFNvY2tldElPLk5hbWVzcGFjZX0gaW9cbiAqIEBwYXJhbSB7U29ja2V0SU8uU29ja2V0fSBzb2NrZXRcbiAqIEBwYXJhbSB7VHlwZX0gY29udHJvbGxlclxuICogQHBhcmFtIHtFdmVudFR5cGV9IHR5cGVcbiAqL1xuZnVuY3Rpb24gYXBwbHlFdmVudHMoXG4gIGlvOiBTb2NrZXRJTy5TZXJ2ZXIgfCBTb2NrZXRJTy5OYW1lc3BhY2UsXG4gIHNvY2tldDogU29ja2V0SU8uU29ja2V0LFxuICBjb250cm9sbGVyOiBUeXBlLFxuICB0eXBlOiBFdmVudFR5cGVcbikge1xuICBjb25zdCBpbnN0YW5jZTogU29ja2V0Q2xhc3MgPSBDb250YWluZXIuZ2V0KGNvbnRyb2xsZXIpO1xuICBjb25zdCBtZXRhOiBTb2NrZXRNZXRhID0gZ2V0TWV0YShpbnN0YW5jZSk7XG4gIGNvbnN0IGlvU29jazogYW55ID0gc29ja2V0IHx8IGlvO1xuXG4gIG1ldGEubGlzdGVuZXJzXG4gICAgLmZpbHRlcigobGlzdGVuZXI6IExpc3RlbmVyKSA9PiBsaXN0ZW5lci50eXBlID09PSB0eXBlKVxuICAgIC5mb3JFYWNoKChsaXN0ZW5lcjogTGlzdGVuZXIpID0+IGlvU29jay5vbihsaXN0ZW5lci5ldmVudCwgKC4uLmFyZ3MpID0+IHtcbiAgICAgIGNvbnN0IG1ldGhvZE5hbWU6IHN0cmluZyA9IGxpc3RlbmVyLm1ldGhvZE5hbWU7XG4gICAgICBjb25zdCBuZXdBcmdzOiBhbnlbXSA9IG1hcEFyZ3VtZW50cyhcbiAgICAgICAgaW8sIHNvY2tldCB8fCBhcmdzWzBdLCBtZXRhLnBhcmFtc1ttZXRob2ROYW1lXSwgYXJnc1xuICAgICAgKTtcblxuICAgICAgcmV0dXJuIGluc3RhbmNlW21ldGhvZE5hbWVdLmFwcGx5KGluc3RhbmNlLCBuZXdBcmdzKTtcbiAgICB9KSk7XG59XG5cbi8qKlxuICogTWFwIHBhcmFtZXRlcnMgZm9yIG5ldyBoYW5kbGVyXG4gKlxuICogQHBhcmFtIHtTb2NrZXRJTy5TZXJ2ZXJ8U29ja2V0SU8uTmFtZXNwYWNlfSBpb1xuICogQHBhcmFtIHtTb2NrZXRJTy5Tb2NrZXR9IHNvY2tldFxuICogQHBhcmFtIHtQYXJhbVtdfSBwYXJhbXMgTWV0YSBwYXJhbWV0ZXJzXG4gKiBAcGFyYW0ge2FueVtdfSBhcmdzIEV2ZW50IGhhbmRsZXIgYXJndW1lbnRzXG4gKiBAcmV0dXJucyB7QXJyYXl9IHJldHVybnMgYXJndW1lbnRzIGFycmF5LCBvciBpbyBhbmQgc29ja2V0LCBldmVudCBhcmdzIGJ5IGRlZmF1bHRcbiAqL1xuZnVuY3Rpb24gbWFwQXJndW1lbnRzKFxuICBpbzogU29ja2V0SU8uU2VydmVyIHwgU29ja2V0SU8uTmFtZXNwYWNlLFxuICBzb2NrZXQ6IFNvY2tldElPLlNvY2tldCxcbiAgcGFyYW1zOiBQYXJhbVtdLFxuICBhcmdzOiBhbnlbXVxuKTogYW55W10ge1xuICAvKipcbiAgICogaWYgbm8gcGFyYW1ldGVycyBwcm92aWRlZCwgcmV0dXJuIGlvIGFuZCBzb2NrZXQsIGFuZCBldmVudCBhcmd1bWVudHNcbiAgICogKHdoaWNoIGNhbWUgZm9yIGRlZmF1bHQgaGFuZGxlcilcbiAgICovXG4gIGlmICghcGFyYW1zIHx8ICFwYXJhbXMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIFtpbywgc29ja2V0LCAuLi5hcmdzXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBsb29wIHRocm91Z2ggYWxsIHBhcmFtcyBhbmQgcHV0IHRoZW0gaW50byBjb3JyZWN0IG9yZGVyXG4gICAqL1xuICByZXR1cm4gcGFyYW1zXG4gICAgLnNvcnQoKHAxOiBQYXJhbSwgcDI6IFBhcmFtKSA9PiBwMS5pbmRleCAtIHAyLmluZGV4KVxuICAgIC5tYXAoKHBhcmFtOiBQYXJhbSkgPT4ge1xuICAgICAgc3dpdGNoIChwYXJhbS50eXBlKSB7XG4gICAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5JTzogcmV0dXJuIGdldFdyYXBwZXIocGFyYW0sIGlvKTtcbiAgICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLlNvY2tldDogcmV0dXJuIGdldFdyYXBwZXIocGFyYW0sIHNvY2tldCk7XG4gICAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5BcmdzOiByZXR1cm4gZ2V0QXJncyhhcmdzKTtcbiAgICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLkFjazogcmV0dXJuIGdldEFjayhhcmdzKTtcbiAgICAgIH1cbiAgICB9KTtcbn1cblxuLyoqXG4gKiBHZXQgYWNrIGNhbGxiYWNrIGZ1bmN0aW9uXG4gKiBAZGVzY3JpcHRpb24gZXh0cmFjdCBjYWxsYmFjayBmdW5jdGlvbiwgaXQgaXQgZXhpc3RzXG4gKlxuICogQHBhcmFtIHthbnlbXX0gYXJncyBFdmVudCBhcmd1bWVudHMsIHBhc3NlZCB0byBoYW5kbGVyIGZ1bmN0aW9uXG4gKi9cbmZ1bmN0aW9uIGdldEFjayhhcmdzOiBhbnlbXSkge1xuICBjb25zdCBhY2tFeGlzdHM6IGJvb2xlYW4gPSB0eXBlb2YgYXJnc1thcmdzLmxlbmd0aCAtIDFdID09PSAnZnVuY3Rpb24nO1xuXG4gIHJldHVybiBhY2tFeGlzdHMgPyBhcmdzLnBvcCgpIDogbm9vcDtcbn1cblxuLyoqXG4gKiBHZXQgcHJvcGVyIG1lc3NhZ2UgZGF0YVxuICpcbiAqIEBwYXJhbSB7YW55W119IGFyZ3NcbiAqXG4gKiBAcmV0dXJucyB7Kn1cbiAqL1xuZnVuY3Rpb24gZ2V0QXJncyhhcmdzOiBhbnlbXSk6IGFueSB7XG4gIHJldHVybiB0eXBlb2YgYXJnc1thcmdzLmxlbmd0aCAtIDFdID09PSAnZnVuY3Rpb24nID9cbiAgICBhcmdzW2FyZ3MubGVuZ3RoIC0gMl0gOiBhcmdzW2FyZ3MubGVuZ3RoIC0gMV07XG59XG5cbi8qKlxuICogR2V0IG9yaWdpbmFsIHNvY2tldCBvciBpbyBzZXJ2ZXIsIG9yIGNyZWF0ZSBpbnN0YW5jZSBvZiBwYXNzZWQgV3JhcHBlckNsYXNzIChkYXRhKVxuICpcbiAqIEBwYXJhbSB7UGFyYW19IGl0ZW1cbiAqIEBwYXJhbSB7b2JqZWN0fSBvYmpcbiAqXG4gKiBAcmV0dXJucyB7Kn1cbiAqL1xuZnVuY3Rpb24gZ2V0V3JhcHBlcihpdGVtOiBQYXJhbSwgb2JqOiBvYmplY3QpOiBhbnkge1xuICByZXR1cm4gaXRlbS53cmFwcGVyID8gbmV3IGl0ZW0ud3JhcHBlcihvYmopIDogb2JqO1xufVxuXG4vKipcbiAqIER1bW15IGVtcHR5IGZ1bmN0aW9uLCB0byBlbnN1cmUgdGhhdCBjYWxsYmFjayBleGlzdHNcbiAqL1xuZnVuY3Rpb24gbm9vcCgpIHt9XG5cbnR5cGUgSU8gPSBTb2NrZXRJTy5TZXJ2ZXIgfCBTb2NrZXRJTy5OYW1lc3BhY2U7XG4iXX0=